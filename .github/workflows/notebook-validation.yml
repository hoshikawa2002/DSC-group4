name: Notebook Validation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate-notebooks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install nbconvert nbformat jupyter

      - name: Find all notebooks
        id: find-notebooks
        run: |
          echo "Found notebooks:"
          find . -name "*.ipynb" -not -path "*/.ipynb_checkpoints/*"

      - name: Validate notebook syntax
        run: |
          echo "Validating notebook structure and metadata..."
          for notebook in $(find . -name "*.ipynb" -not -path "*/.ipynb_checkpoints/*"); do
            echo "Checking: $notebook"
            jupyter nbconvert --to notebook --execute --inplace "$notebook" --ExecutePreprocessor.enabled=False || exit 1
            echo "✓ $notebook is valid"
          done

      - name: Check notebook metadata
        run: |
          python -c "
          import nbformat
          import sys
          from pathlib import Path

          notebooks = list(Path('.').rglob('*.ipynb'))
          notebooks = [nb for nb in notebooks if '.ipynb_checkpoints' not in str(nb)]

          print(f'Checking metadata for {len(notebooks)} notebooks...')
          for nb_path in notebooks:
              try:
                  nb = nbformat.read(nb_path, as_version=4)
                  print(f'✓ {nb_path}: {len(nb.cells)} cells')
              except Exception as e:
                  print(f'✗ {nb_path}: {e}', file=sys.stderr)
                  sys.exit(1)
          print('All notebooks have valid metadata!')
          "

      - name: Generate notebook report
        run: |
          echo "# Notebook Validation Report" > notebook-report.md
          echo "" >> notebook-report.md
          echo "## Summary" >> notebook-report.md
          echo "- Total notebooks: $(find . -name '*.ipynb' -not -path '*/.ipynb_checkpoints/*' | wc -l)" >> notebook-report.md
          echo "- Validation date: $(date)" >> notebook-report.md
          echo "" >> notebook-report.md
          echo "## Notebooks" >> notebook-report.md
          for notebook in $(find . -name "*.ipynb" -not -path "*/.ipynb_checkpoints/*"); do
            echo "- $notebook" >> notebook-report.md
          done

      - name: Upload validation report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: notebook-validation-report
          path: notebook-report.md
          retention-days: 30
